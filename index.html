<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Decentralized music streaming platform with ETH bidding system and blockchain-powered queue management on Polygon zkEVM">
    <meta name="keywords" content="decentralized music, blockchain streaming, ETH bidding, Polygon zkEVM, Web3 music">
    <meta name="theme-color" content="#00bfff">
    <title>Encode Play - Decentralized Music Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #121212 25%, #1a1a1a 50%, #0d1117 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-right: 1px solid #333;
            padding: 2rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #00bfff 75%, #6a5acd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow-text 4s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
        }

        @keyframes rainbow-text {
            0%, 100% { 
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #00bfff 75%, #6a5acd 100%);
                -webkit-background-clip: text;
                background-clip: text;
            }
            50% { 
                background: linear-gradient(135deg, #6a5acd 0%, #00bfff 25%, #45b7d1 50%, #4ecdc4 75%, #ff6b6b 100%);
                -webkit-background-clip: text;
                background-clip: text;
            }
        }

        .logo-container {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #00bfff 75%, #6a5acd 100%);
            padding: 0.75rem;
            border-radius: 12px;
            margin-right: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.4), 0 0 20px rgba(69, 183, 209, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .logo-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), rgba(138, 43, 226, 0.3), rgba(30, 144, 255, 0.3), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            color: white;
            position: relative;
            z-index: 1;
        }

        .logo-image {
            width: 2rem;
            height: 2rem;
            object-fit: contain;
            filter: brightness(0) invert(1);
            position: relative;
            z-index: 1;
        }
  
        .wallet-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .wallet-title {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            color: #00bfff;
            font-weight: 600;
        }

        .wallet-title i {
            margin-right: 0.5rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b3b3b3;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.2);
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .button-group + .button-group {
            margin-top: 1rem !important;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2a7a4b, #3a8a5b);
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(42, 122, 75, 0.3);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), rgba(78, 205, 196, 0.1), rgba(69, 183, 209, 0.1), transparent);
            animation: shimmer 4s infinite;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(42, 122, 75, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .account-display {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0, 191, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 191, 255, 0.3);
            font-size: 0.8rem;
            color: #1e90ff;
            word-break: break-all;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .header {
            margin-bottom: 2rem;
            position: relative;
        }

        .header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #fff, #b3b3b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #b3b3b3;
            font-size: 1rem;
        }

        .queue-info {
            position: absolute;
            top: 0;
            right: 0;
            cursor: pointer;
        }

        .queue-badge {
            background: linear-gradient(45deg, #6b4c93, #4682b4);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(107, 76, 147, 0.3);
        }

        .queue-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), rgba(0, 191, 255, 0.1), rgba(69, 183, 209, 0.1), transparent);
            animation: shimmer 4s infinite;
        }

        .queue-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 76, 147, 0.4);
        }

        .queue-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            width: 350px;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(15, 15, 15, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .queue-info:hover .queue-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-section {
            margin-bottom: 1.5rem;
        }

        .dropdown-section:last-child {
            margin-bottom: 0;
        }

        .dropdown-title {
            color: #00bfff;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .queue-item:last-child {
            margin-bottom: 0;
        }

        .queue-item-title {
            color: #fff;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #b3b3b3;
        }

        .submitter {
            font-family: monospace;
            background: rgba(0, 191, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            color: #1e90ff;
        }

        .timestamp {
            color: #888;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00bfff;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #b3b3b3;
        }

        .player-container {
            flex: 1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .player-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
            min-height: 400px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: #b3b3b3;
        }

        .loading i {
            font-size: 3rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .status-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #00bfff;
        }

        .no-content {
            color: #ffd700;
        }

        .help-badge {
            background: linear-gradient(45deg, #cd5c5c, #d2691e);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(205, 92, 92, 0.3);
        }

        .help-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), rgba(255, 165, 0, 0.1), rgba(255, 140, 0, 0.1), transparent);
            animation: shimmer 4s infinite;
        }

        .help-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(205, 92, 92, 0.4);
        }

        .help-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            width: 90vh;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(15, 15, 15, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .help-info:hover .help-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .header-link {
            color: #00bfff;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .header-link:hover {
            color: #1e90ff;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
            
            .help-info, .queue-info {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                left: auto !important;
                margin: 1rem 0 !important;
                display: block;
                width: 100%;
            }
            
            .help-dropdown, .queue-dropdown {
                width: calc(100vw - 2rem) !important;
                left: 50% !important;
                transform: translateX(-50%) translateY(-10px) !important;
                right: auto !important;
                max-width: 400px;
            }
            
            .help-info:hover .help-dropdown,
            .queue-info:hover .queue-dropdown {
                transform: translateX(-50%) translateY(0) !important;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #00bfff;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1e90ff;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-container">
                    <img src="static/logo.png" alt="Logo" class="logo-image">
                </div>
                <h1>Encode Play</h1>
            </div>

            <div class="wallet-section">
                <div class="wallet-title">
                    <i class="fas fa-wallet"></i>
                    Wallet Configuration
                </div>
                
                <div class="input-group">
                    <label for="privateKey">
                        <i class="fas fa-key"></i> Private Key
                    </label>
                    <input type="password" id="privateKey" placeholder="Enter your private key">
                </div>

                <div class="input-group">
                    <label for="bidUrl">
                        <i class="fas fa-link"></i> Content URL (max 42 chars)
                    </label>
                    <input type="text" id="bidUrl" placeholder="https://youtu.be/content">
                </div>

                <div class="input-group">
                    <label for="bidValue">
                        <i class="fas fa-coins"></i> Bid Value (Wei)
                    </label>
                    <input type="number" id="bidValue" placeholder="1000000000000000000" min="0">
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="submitBid()">
                        <i class="fas fa-play"></i>
                        Submit Bid
                    </button>
                    <button class="btn btn-secondary" onclick="refreshContent()">
                        <i class="fas fa-sync"></i>
                        Refresh
                    </button>
                </div>
                <br>
                <div class="button-group" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="testConnection()">
                        <i class="fas fa-heart-pulse"></i>
                        Test Connection
                    </button>
                </div>

                <div id="addressDisplay" class="account-display" style="display: none;"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h2>Now Playing</h2>
                <p>Decentralized music streaming powered by <a href="https://cardona-zkevm.polygonscan.com/address/0x1a7dbe663e5efb9f3aaf2eb56616794069d3f4ea" target="_blank" class="header-link">Polygon zkEVM Smart Contract</a></p>
                <div class="queue-info" id="queueInfo">
                    <div class="queue-badge">
                        <i class="fas fa-list"></i>
                        <span id="queueCount">0</span> in queue
                    </div>
                    
                    <div class="queue-dropdown" id="queueDropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-title">
                                <i class="fas fa-chart-bar"></i>
                                Queue Stats
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="totalCount">0</div>
                                    <div class="stat-label">Total Items</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="activeItems">0</div>
                                    <div class="stat-label">Active</div>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown-section" id="currentSection" style="display: none;">
                            <div class="dropdown-title">
                                <i class="fas fa-play"></i>
                                Currently Playing
                            </div>
                            <div class="queue-item" id="currentItem">
                                <div class="queue-item-title" id="currentTitle">No content</div>
                                <div class="queue-item-meta">
                                    <span class="submitter" id="currentSubmitter">N/A</span>
                                    <span class="timestamp" id="currentTime">N/A</span>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown-section" id="nextSection" style="display: none;">
                            <div class="dropdown-title">
                                <i class="fas fa-forward"></i>
                                Coming Up Next
                            </div>
                            <div class="queue-item" id="nextItem">
                                <div class="queue-item-title" id="nextTitle">No content</div>
                                <div class="queue-item-meta">
                                    <span class="submitter" id="nextSubmitter">N/A</span>
                                    <span class="timestamp" id="nextTime">N/A</span>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown-section" id="recentSection" style="display: none;">
                            <div class="dropdown-title">
                                <i class="fas fa-history"></i>
                                Recent Submissions
                            </div>
                            <div id="recentItems"></div>
                        </div>
                    </div>
                </div>
                <div class="help-info" style="position: absolute; top: 0; right: 0; cursor: pointer; margin-top: 50px;">
                    <div class="help-badge">
                        <i class="fas fa-question-circle"></i>
                        How it Works
                    </div>
                    <div class="help-dropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-title">
                                <i class="fas fa-coins"></i>
                                Bidding System
                            </div>
                            <div style="color: #b3b3b3; font-size: 0.9rem; line-height: 1.5;">
                                <p><strong>Higher bids = Higher priority!</strong></p>
                                <p>• Submit your Music URL with an ETH bid</p>
                                <p>• The more you bid, the higher you rank in the queue</p>
                                <p>• Queue automatically advances every 3 minutes</p>
                                <p>• Your content plays when it reaches the top</p>
                            </div>
                        </div>
                        
                        <div class="dropdown-section">
                            <div class="dropdown-title">
                                <i class="fas fa-lightbulb"></i>
                                Tips
                            </div>
                            <div style="color: #b3b3b3; font-size: 0.9rem; line-height: 1.5;">
                                <p>• Use YouTube URLs for best experience</p>
                                <p>• Max URL length is 42 chars</p>
                                <p>• Bid in Wei (1 ETH = 10^18 Wei)</p>
                                <p>• Check queue stats to see competition</p>
                                <p>• Get testnet ETH from the <a href="https://faucet.triangleplatform.com/polygonzkevm/cardona" target="_blank" class="header-link">faucet <i class="fas fa-external-link-alt"></i></a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="player-container" id="player-container">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Loading current content...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Blockchain configuration
        const RPC_URL = "https://rpc.cardona.zkevm-rpc.com";
        const CONTRACT_ADDRESS = "0x1a7dbe663E5efb9f3aAF2EB56616794069d3F4eA";
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"PaymentReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"data","type":"string"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"},{"indexed":true,"internalType":"address","name":"submitter","type":"address"}],"name":"SubmissionAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"data","type":"string"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"},{"indexed":true,"internalType":"address","name":"submitter","type":"address"}],"name":"SubmissionPopped","type":"event"},{"inputs":[],"name":"MAX_QUEUE_SIZE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"POP_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentSong","outputs":[{"internalType":"string","name":"data","type":"string"},{"internalType":"uint256","name":"timeRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getDataByIndex","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getSubmissionByIndex","outputs":[{"internalType":"string","name":"data","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address","name":"submitter","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSubmissionCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSubmissions","outputs":[{"components":[{"internalType":"string","name":"data","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address","name":"submitter","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct ValueSortedStorage.Submission[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getSubmitterByIndex","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTimeUntilNextPop","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTimestampByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTopSubmission","outputs":[{"internalType":"string","name":"data","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address","name":"submitter","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPopTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"popIfReady","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_data","type":"string"}],"name":"submitData","outputs":[],"stateMutability":"payable","type":"function"}];

        // Initialize Web3
        let web3;
        let contract;
        let currentAccount = null;
        let currentPlayingUrl = null;

        // Initialize blockchain connection
        function initBlockchain() {
            try {
                web3 = new Web3(RPC_URL);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                console.log('Blockchain connection initialized');
                return true;
            } catch (error) {
                console.error('Error initializing blockchain:', error);
                return false;
            }
        }

        // Validate and set private key
        function setPrivateKey(privateKey) {
            try {
                const cleanKey = privateKey.replace('0x', '');
                if (cleanKey.length !== 64) {
                    throw new Error(`Private key must be 64 hex characters, got ${cleanKey.length} characters`);
                }
                
                currentAccount = web3.eth.accounts.privateKeyToAccount('0x' + cleanKey);
                console.log('Account created:', currentAccount.address);
                
                const addressDisplay = document.getElementById('addressDisplay');
                addressDisplay.style.display = 'block';
                addressDisplay.innerHTML = `<i class="fas fa-check-circle"></i> Connected: ${currentAccount.address.slice(0, 6)}...${currentAccount.address.slice(-4)}`;
                
                return true;
            } catch (error) {
                console.error('Error setting private key:', error);
                alert('Error: ' + error.message);
                return false;
            }
        }

        // Load current song from blockchain
        async function loadCurrentSong() {
            try {
                if (!contract) {
                    throw new Error('Blockchain not initialized');
                }

                const result = await contract.methods.getCurrentSong().call();
                const url = result[0];
                
                const container = document.getElementById('player-container');
                
                if (url && url !== '') {
                    let embedUrl = url;
                    if (url.includes('youtube.com/watch?v=')) {
                        const videoId = url.split('v=')[1].split('&')[0];
                        embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0`;
                    } else if (url.includes('youtu.be/')) {
                        const videoId = url.split('youtu.be/')[1].split('?')[0];
                        embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0`;
                    }
                    container.innerHTML = `<iframe src="${embedUrl}" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
                } else {
                    container.innerHTML = `<div class="status-message no-content"><i class="fas fa-music"></i><br>No content currently playing</div>`;
                }
            } catch (error) {
                console.error('Error loading current song:', error);
                document.getElementById('player-container').innerHTML = 
                    `<div class="status-message error"><i class="fas fa-wifi"></i><br>Error loading content: ${error.message}</div>`;
            }
        }

        // Load queue metadata
        async function loadQueueMetadata() {
            try {
                if (!contract) {
                    throw new Error('Blockchain not initialized');
                }

                const totalCount = await contract.methods.getSubmissionCount().call();
                
                // Update queue count badge
                document.getElementById('queueCount').textContent = totalCount;
                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('activeItems').textContent = totalCount;
                
                // Get current playing info
                if (totalCount > 0) {
                    try {
                        const submission = await contract.methods.getSubmissionByIndex(0).call();
                        const submitter = await contract.methods.getSubmitterByIndex(0).call();
                        const timestamp = await contract.methods.getTimestampByIndex(0).call();
                        
                        document.getElementById('currentSection').style.display = 'block';
                        document.getElementById('currentTitle').textContent = extractContentTitle(submission[0]);
                        document.getElementById('currentSubmitter').textContent = `${submitter.slice(0, 6)}...${submitter.slice(-4)}`;
                        document.getElementById('currentTime').textContent = formatTimestamp(timestamp);
                    } catch (error) {
                        console.error('Error getting current playing:', error);
                        document.getElementById('currentSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('currentSection').style.display = 'none';
                }
                
                // Get next up info
                if (totalCount > 1) {
                    try {
                        const submission = await contract.methods.getSubmissionByIndex(1).call();
                        const submitter = await contract.methods.getSubmitterByIndex(1).call();
                        const timestamp = await contract.methods.getTimestampByIndex(1).call();
                        
                        document.getElementById('nextSection').style.display = 'block';
                        document.getElementById('nextTitle').textContent = extractContentTitle(submission[0]);
                        document.getElementById('nextSubmitter').textContent = `${submitter.slice(0, 6)}...${submitter.slice(-4)}`;
                        document.getElementById('nextTime').textContent = formatTimestamp(timestamp);
                    } catch (error) {
                        console.error('Error getting next submission:', error);
                        document.getElementById('nextSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('nextSection').style.display = 'none';
                }
                
                // Get recent submissions
                if (totalCount > 0) {
                    document.getElementById('recentSection').style.display = 'block';
                    const recentContainer = document.getElementById('recentItems');
                    recentContainer.innerHTML = '';
                    
                    const recentCount = Math.min(totalCount, 3);
                    for (let i = 0; i < recentCount; i++) {
                        try {
                            const submission = await contract.methods.getSubmissionByIndex(i).call();
                            const submitter = await contract.methods.getSubmitterByIndex(i).call();
                            const timestamp = await contract.methods.getTimestampByIndex(i).call();
                            
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'queue-item';
                            itemDiv.innerHTML = `
                                <div class="queue-item-title">#${i + 1} ${extractContentTitle(submission[0])}</div>
                                <div class="queue-item-meta">
                                    <span class="submitter">${submitter.slice(0, 6)}...${submitter.slice(-4)}</span>
                                    <span class="timestamp">${formatTimestamp(timestamp)}</span>
                                </div>
                            `;
                            recentContainer.appendChild(itemDiv);
                        } catch (error) {
                            console.error(`Error getting submission ${i}:`, error);
                        }
                    }
                } else {
                    document.getElementById('recentSection').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading queue metadata:', error);
            }
        }

        // Submit bid to blockchain
        async function submitBid() {
            const privateKey = document.getElementById('privateKey').value;
            const bidUrl = document.getElementById('bidUrl').value;
            const bidValue = document.getElementById('bidValue').value;
            
            if (!privateKey) {
                alert('Please enter your private key');
                return;
            }
            
            if (!bidUrl) {
                alert('Please enter a content URL');
                return;
            }
            
            if (!bidValue || bidValue <= 0) {
                alert('Please enter a valid bid value in Wei');
                return;
            }
            
            try {
                // Set private key first
                if (!setPrivateKey(privateKey)) {
                    return;
                }
                
                if (!contract) {
                    throw new Error('Blockchain not initialized');
                }
                
                // Build transaction
                const gasPrice = await web3.eth.getGasPrice();
                const nonce = await web3.eth.getTransactionCount(currentAccount.address);
                
                const transaction = {
                    from: currentAccount.address,
                    to: CONTRACT_ADDRESS,
                    value: bidValue,
                    gas: 200000,
                    gasPrice: gasPrice,
                    nonce: nonce,
                    data: contract.methods.submitData(bidUrl).encodeABI()
                };
                
                // Sign and send transaction
                const signedTx = await web3.eth.accounts.signTransaction(transaction, currentAccount.privateKey);
                const receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
                
                alert(`Bid submitted successfully!\\nTransaction: ${receipt.transactionHash}\\nBlock: ${receipt.blockNumber}`);
                
                // Clear form
                document.getElementById('bidUrl').value = '';
                document.getElementById('bidValue').value = '';
                
                // Refresh content
                setTimeout(() => {
                    loadCurrentSong();
                    loadQueueMetadata();
                }, 2000);
                
            } catch (error) {
                console.error('Error submitting bid:', error);
                alert('Error submitting bid: ' + error.message);
            }
        }

        // Test blockchain connection
        async function testConnection() {
            try {
                const isConnected = await web3.eth.net.isListening();
                const blockNumber = await web3.eth.getBlockNumber();
                
                alert(`Connection Test:\\n\\nBlockchain: ${isConnected ? 'Connected' : 'Disconnected'}\\nLatest Block: ${blockNumber}\\nContract: ${CONTRACT_ADDRESS}`);
                
                // Also test contract calls
                loadCurrentSong();
                loadQueueMetadata();
                
            } catch (error) {
                console.error('Connection test failed:', error);
                alert(`Connection test failed: ${error.message}`);
            }
        }

        // Refresh all content
        function refreshContent() {
            const privateKey = document.getElementById('privateKey').value;
            if (privateKey) {
                setPrivateKey(privateKey);
            }
            loadCurrentSong();
            loadQueueMetadata();
        }

        // Check for content updates
        async function checkForUpdates() {
            try {
                if (!contract) return;
                
                const result = await contract.methods.getCurrentSong().call();
                const url = result[0];
                
                if (url !== currentPlayingUrl) {
                    console.log('Content changed, refreshing player');
                    currentPlayingUrl = url;
                    loadCurrentSong();
                    loadQueueMetadata();
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }

        // Utility functions
        function extractContentTitle(url) {
            if (!url) return 'Unknown Content';
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                return 'YouTube Video';
            }
            
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain.charAt(0).toUpperCase() + domain.slice(1);
            } catch {
                return url.slice(0, 30) + (url.length > 30 ? '...' : '');
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown';
            
            try {
                const date = new Date(timestamp * 1000);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                
                return date.toLocaleDateString();
            } catch {
                return 'Unknown';
            }
        }

        // Background queue advancement (simulates the backend service)
        async function popIfReady() {
            try {
                if (!currentAccount || !contract) {
                    console.log('No account available for popIfReady');
                    return;
                }
                
                // Check if queue is empty
                const submissionCount = await contract.methods.getSubmissionCount().call();
                if (submissionCount == 0) {
                    console.log('Queue is empty - skipping popIfReady');
                    return;
                }
                
                const gasPrice = await web3.eth.getGasPrice();
                const nonce = await web3.eth.getTransactionCount(currentAccount.address);
                
                const transaction = {
                    from: currentAccount.address,
                    to: CONTRACT_ADDRESS,
                    gas: 200000,
                    gasPrice: gasPrice,
                    nonce: nonce,
                    data: contract.methods.popIfReady().encodeABI()
                };
                
                const signedTx = await web3.eth.accounts.signTransaction(transaction, currentAccount.privateKey);
                const receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
                console.log('popIfReady transaction sent:', receipt.transactionHash);
                
            } catch (error) {
                if (error.message.includes('3 minutes have not passed yet')) {
                    console.log('popIfReady called too early - 3 minutes have not passed yet');
                } else {
                    console.log('Error calling popIfReady:', error.message);
                }
            }
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            if (initBlockchain()) {
                loadCurrentSong();
                loadQueueMetadata();
                
                // Check for content changes every 5 seconds
                setInterval(checkForUpdates, 5000);
                
                // Refresh queue metadata every 30 seconds
                setInterval(loadQueueMetadata, 30000);
                
                // Try to advance queue every 3 minutes (if account is set)
                setInterval(popIfReady, 180000);
            } else {
                document.getElementById('player-container').innerHTML = 
                    `<div class="status-message error"><i class="fas fa-exclamation-triangle"></i><br>Failed to initialize blockchain connection</div>`;
            }
        });
    </script>
</body>
</html>